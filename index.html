<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è£œåŠ©é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã€é«˜ç²¾åº¦ãƒ»å®Œçµç‰ˆã€‘</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <style>
        :root { --primary: #005bac; --bg: #f4f7f9; --green: #28a745; --red: #d9534f; --gray: #888; --line: #06c755; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 10px; margin: 0; color: #333; }
        
        /* æ“ä½œç”¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .action-nav { position: sticky; top: 0; z-index: 1000; background: var(--bg); padding: 10px 0; display: flex; gap: 6px; justify-content: center; max-width: 550px; margin: 0 auto; }
        .btn { flex: 1; border-radius: 8px; cursor: pointer; font-size: 0.75rem; font-weight: bold; padding: 12px 2px; border: none; color: #fff; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .reset-btn { background-color: var(--red); }
        .save-btn { background-color: var(--primary); }
        .line-btn { background-color: var(--line); }
        .btn:active { opacity: 0.7; transform: translateY(1px); }

        /* ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¨ãƒªã‚¢ */
        #capture-area { max-width: 550px; margin: 0 auto; padding-bottom: 20px; background: var(--bg); }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; box-sizing: border-box; }
        h2 { font-size: 1.1rem; color: var(--primary); text-align: center; border-bottom: 2px solid var(--primary); padding-bottom: 8px; margin-top: 0; margin-bottom: 15px; }
        
        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆç”»é¢ãƒ»ç”»åƒå…±é€šï¼‰ */
        .form-label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; }
        input, select, textarea { 
            width: 100%; 
            height: 45px; 
            padding: 0 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 1rem; 
            box-sizing: border-box; 
            display: flex;
            align-items: center;
            background: #fff;
            outline: none;
            -webkit-appearance: none;
        }
        textarea { height: 65px; padding: 10px 12px; line-height: 1.4; resize: none; }
        input:focus { border-color: var(--primary); background: #f0f7ff; }
        
        /* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è£…é£¾ */
        .section-frame { border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .result-frame { border: 2px solid #444; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .profit-frame { border: 2px solid #ddd; border-radius: 10px; padding: 15px; background: #fffde6; }
        
        .tax-label { font-size: 0.75rem; color: var(--gray); margin-top: 4px; text-align: right; margin-bottom: 10px; }
        .res-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
        .val-text { font-size: 1.1rem; }
        .footer-note { font-size: 0.7rem; color: #888; text-align: center; line-height: 1.4; margin-top: 10px; }
    </style>
</head>
<body>

<div class="action-nav">
    <button class="btn reset-btn" onclick="resetAll()">ğŸ”„ å…¨æ¶ˆå»</button>
    <button class="btn save-btn" onclick="savePageImage()">ğŸ“¸ ç”»åƒä¿å­˜</button>
    <button class="btn line-btn" onclick="shareLine()">ğŸ’¬ å…±æœ‰</button>
</div>

<div id="capture-area">
    <div class="container">
        <h2>æ¡ˆä»¶ç®¡ç†æƒ…å ±</h2>
        <div style="margin-bottom:12px;">
            <label class="form-label">æ¡ˆä»¶åï¼ˆä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«åï¼‰</label>
            <input id="jobName" type="text" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã€‡ã€‡æ§˜" oninput="saveAndCalc()">
        </div>
        <div>
            <label class="form-label">å•†è«‡ãƒ¡ãƒ¢</label>
            <textarea id="memo" placeholder="å‚™è€ƒã€æ¡ä»¶ãªã©" oninput="saveAndCalc()"></textarea>
        </div>
    </div>

    <div class="container">
        <h2>ITå°å…¥è£œåŠ©é‡‘</h2>
        <div class="section-frame">
            <label class="form-label">â‘  ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è²©å£²é¡ï¼ˆç¨åˆ¥ï¼‰</label>
            <input id="C4" type="number" pattern="\d*" oninput="saveAndCalc()">
            <div class="tax-label">ç¨è¾¼ï¼š<span id="D4">0</span> å††</div>
            
            <label class="form-label">â‘¡ POSãƒãƒ¼ãƒ‰è²©å£²é¡ï¼ˆç¨åˆ¥ï¼‰</label>
            <input id="C5" type="number" pattern="\d*" oninput="saveAndCalc()">
            <div class="tax-label">ç¨è¾¼ï¼š<span id="D5">0</span> å††</div>
            
            <label class="form-label">â‘¢ PCè²©å£²é¡ï¼ˆç¨åˆ¥ï¼‰</label>
            <input id="C6" type="number" pattern="\d*" oninput="saveAndCalc()">
            <div class="tax-label">ç¨è¾¼ï¼š<span id="D6">0</span> å††</div>
        </div>

        <div class="result-frame">
            <label class="form-label">â‘¥ ALLå•†æåŸä¾¡è²»ç”¨ï¼ˆç¨åˆ¥ï¼‰</label>
            <input id="C30" type="number" pattern="\d*" oninput="saveAndCalc()">
            <div class="tax-label">ç¨è¾¼åŸä¾¡ï¼š<span id="D30">0</span> å††</div>
            
            <div class="res-row"><span>â‘£ ç›®å®‰è£œåŠ©é‡‘é¡</span><span class="val-text" id="G5" style="color:var(--primary)">0 å††</span></div>
            <div class="res-row" style="color:var(--red)"><span>â‘¤ å®Ÿè³ªè² æ‹…ï¼ˆæ‰‹å‡ºã—ï¼‰</span><span class="val-text" id="G6">0 å††</span></div>
        </div>

        <div class="profit-frame">
            <div class="res-row" style="color:var(--green)"><span>â‘¦ è²©å£²åº—æ§˜æ‰•å‡ºç¨è¾¼é¡</span><span class="val-text" id="G30">0 å††</span></div>
            <div class="res-row" style="color:var(--red)"><span>â‘§ æ¦‚ç®—ç²—åˆ©ç›Šï¼ˆç¨è¾¼ï¼‰</span><span class="val-text" id="G31" style="font-size:1.3rem;">0 å††</span></div>
            <div style="font-size:0.6rem; color:#888; text-align:right;">â€»è«¸çµŒè²»ç­‰ã‚’å¼•ãå‰ã®åˆ©ç›Šç›®å®‰ã§ã™</div>
        </div>
    </div>

    <div class="container">
        <h2>æŒç¶šåŒ–è£œåŠ©é‡‘</h2>
        <select id="rateSelect" onchange="saveAndCalc()" style="margin-bottom:15px;">
            <option value="0.6666666667">é€šå¸¸ç”³è«‹ (2/3)</option>
            <option value="0.75">èµ¤å­—ãƒ»è³ƒä¸Šã’ç­‰ (3/4)</option>
        </select>
        
        <div class="section-frame">
            <label class="form-label">ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆé–¢é€£è²»</label>
            <input type="number" id="webExp" pattern="\d*" oninput="saveAndCalc()">
            <label class="form-label" style="margin-top:12px;">ã‚¦ã‚§ãƒ–ä»¥å¤–ï¼ˆè¨­å‚™ãƒ»åºƒå ±ç­‰ï¼‰</label>
            <input type="number" id="otherExp" pattern="\d*" oninput="saveAndCalc()">
        </div>

        <div class="result-frame">
            <div class="res-row" style="color:var(--primary)"><span>â‘¥ è£œåŠ©é‡‘äº¤ä»˜ç”³è«‹é¡</span><span class="val-text" id="res6">0 å††</span></div>
            <div class="res-row" style="color:var(--red)"><span>â‘¦ æ‰‹å‡ºã—é¡ï¼ˆæ¦‚ç®—ï¼‰</span><span class="val-text" id="res7">0 å††</span></div>
        </div>
        <div class="footer-note">â€»ITãƒ„ãƒ¼ãƒ«æ¤œç´¢ã¯ã€Œå—ç™ºæ³¨ã€ç­‰ã§å…¬å¼ä¸€è¦§ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
    </div>
</div>

<script>
const fmt = (n) => Math.round(n).toLocaleString();
const fields = ["jobName", "memo", "C4", "C5", "C6", "C30", "webExp", "otherExp", "rateSelect"];

// å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ä¿å­˜ã¨è¨ˆç®—
function saveAndCalc() {
    fields.forEach(id => { localStorage.setItem(id, document.getElementById(id).value); });
    calcTop(); runCalcBottom();
}

window.onload = function() {
    fields.forEach(id => {
        const val = localStorage.getItem(id);
        if (val !== null) document.getElementById(id).value = val;
    });
    calcTop(); runCalcBottom();
};

function resetAll() {
    if(!confirm("å…¥åŠ›ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) return;
    fields.forEach(id => {
        localStorage.removeItem(id);
        document.getElementById(id).value = (id === "rateSelect") ? "0.6666666667" : "";
    });
    saveAndCalc();
}

// ã€æ”¹è‰¯ç‰ˆã€‘ç”»åƒä¿å­˜å‡¦ç†ï¼šæ–‡å­—åˆ‡ã‚Œã¨ã‚ºãƒ¬ã‚’å¾¹åº•ä¿®æ­£
function savePageImage() {
    if(typeof html2canvas === 'undefined') {
        alert("ç”»åƒã‚¨ãƒ³ã‚¸ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚æ•°ç§’å¾…ã£ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
        return;
    }
    const btn = document.querySelector('.save-btn');
    btn.innerText = "ä½œæˆä¸­...";
    const target = document.querySelector("#capture-area");
    const jobName = document.getElementById("jobName").value || "è£œåŠ©é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³";

    html2canvas(target, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#f4f7f9",
        scrollY: -window.scrollY,
        onclone: (clonedDoc) => {
            // å…¥åŠ›æ¬„ã‚’æ’®å½±ç”¨ã«ã€Œã‚ºãƒ¬ãªã„ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã€ã¸ç½®æ›
            const inputs = clonedDoc.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                const val = input.value;
                const parent = input.parentElement;
                const div = clonedDoc.createElement('div');
                
                // å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶™æ‰¿ã—ã¤ã¤ã€æ–‡å­—ä½ç½®ã‚’ä¸­å¤®ã«å›ºå®š
                const style = window.getComputedStyle(input);
                div.style.cssText = `
                    width: ${input.offsetWidth}px;
                    height: ${input.offsetHeight}px;
                    padding: ${style.padding};
                    border: ${style.border};
                    border-radius: ${style.borderRadius};
                    font-size: ${style.fontSize};
                    font-weight: bold;
                    background: white;
                    display: flex;
                    align-items: center;
                    box-sizing: border-box;
                    color: #333;
                `;
                div.innerText = val ? (input.type === 'number' && !isNaN(val) ? Number(val).toLocaleString() : val) : " ";
                
                input.style.display = 'none';
                parent.appendChild(div);
            });
        }
    }).then(canvas => {
        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const now = new Date();
            const timeStr = `${now.getMonth()+1}${now.getDate()}_${now.getHours()}${now.getMinutes()}`;
            a.href = url;
            a.download = `${jobName}_${timeStr}.png`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                btn.innerText = "ğŸ“¸ ç”»åƒä¿å­˜";
            }, 100);
        }, 'image/png');
    });
}

function shareLine() {
    const job = document.getElementById("jobName").value || "æ¡ˆä»¶";
    const text = `ã€è£œåŠ©é‡‘è¨ˆç®—çµæœï¼š${job}ã€‘\nâ€»è©³ç´°ã¯ä¿å­˜ç”»åƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
    navigator.clipboard.writeText(text).then(() => {
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
        alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚LINEç­‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
    });
}

// ITå°å…¥è£œåŠ©é‡‘ è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
function calcTop(){
    const C4=Number(document.getElementById("C4").value)||0, C5=Number(document.getElementById("C5").value)||0, C6=Number(document.getElementById("C6").value)||0, C30=Number(document.getElementById("C30").value)||0;
    const D4=C4*1.1, D5=C5*1.1, D6=C6*1.1, D30=C30*1.1;
    let G5_calc=(C4>=666667)?C4-666667:C4;
    let I5=(G5_calc>=666667)?G5_calc/3*2:G5_calc*0.75, I6=(C4-G5_calc)*0.75, I7=Math.min(I5+I6,3500000);
    let optB=(C5>=400000)?200000:C5*0.5, svcB=(C6>=200000)?100000:C6*0.5;
    const sub=I7+optB+svcB, diff=(D4+D5+D6)-sub, payout=(D4+D5+D6)-D30, profit=payout-diff;
    document.getElementById("D4").textContent=fmt(D4); document.getElementById("D5").textContent=fmt(D5); document.getElementById("D6").textContent=fmt(D6); document.getElementById("D30").textContent=fmt(D30);
    document.getElementById("G5").textContent=fmt(sub)+" å††"; document.getElementById("G6").textContent=fmt(diff)+" å††"; document.getElementById("G30").textContent=fmt(payout)+" å††"; document.getElementById("G31").textContent=fmt(profit)+" å††";
}

// æŒç¶šåŒ–è£œåŠ©é‡‘ è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
function runCalcBottom() {
    const web = parseFloat(document.getElementById('webExp').value) || 0, other = parseFloat(document.getElementById('otherExp').value) || 0, rate = parseFloat(document.getElementById('rateSelect').value);
    const r4 = Math.floor(other * rate), v3_1 = Math.min(other * 0.25, 500000), r3 = Math.floor(Math.min(v3_1, web * rate, r4 / 3));
    const r5 = web + other, r6 = Math.min(r3 + r4, 2000000), r7 = r5 - r6;
    document.getElementById('res6').innerText = fmt(r6) + " å††"; document.getElementById('res7').innerText = fmt(r7) + " å††";
}
</script>
</body>
</html>
